<html>
<head>
    <title>24h color clock delux</title>
</head>
<body id="body">
    <div id="txt" style="opacity:0.4;font-size:44pt"></div>
</body>
<script src="../animation.browser.js"></script>
<script>

function pad(s, h, l) {
    s = "" + s;
    if (s.length >= l) return s;
    return new Array(l - s.length + 1).join(""+h) + s;
}

// x, y, z, r, g, b, h, s, l are all in the range [0,1]

function mul(col, n) {
    var c = {};
    for (var k in col)
        c[k] = col[k] * n;
    return c;
}

function norm(col, n) {
    return mul(col, 1/n);
}

function xyz2rgb(c) {
    var r = {
        r:c.x *  3.2406 + c.y * -1.5372 + c.z * -0.4986,
        g:c.x * -0.9689 + c.y *  1.8758 + c.z *  0.0415,
        b:c.x *  0.0557 + c.y * -0.2040 + c.z *  1.0570
    };
    var _proc = 1 / 2.4;
    for (var k in r) {
        if ( r[k] > 0.0031308 )
            r[k] = 1.055 * Math.pow( r[k], _proc ) - 0.055;
        else
            r[k] = 12.92 * r[k];
    }
    return r;
}

function rgb2xyz(col) {
    var c = {};
    var _proc = 1 / 1.055;
    for (var k in col) {
        c[k] = col[k];
        if ( c[k] > 0.04045 )
            c[k] = Math.pow( ( c[k] + 0.055 ) * _proc, 2.4);
        else
            c[k] /= 12.92;
    }
    return {
        x: c.r * 0.4124 + c.g * 0.3576 + c.b * 0.1805,
        y: c.r * 0.2126 + c.g * 0.7152 + c.b * 0.0722,
        z: c.r * 0.0193 + c.g * 0.1192 + c.b * 0.9505
    };
}

function rgb2hsl(col) {
    var max = Math.max(col.r,col.g,col.b), min = Math.min(col.r,col.g,col.b);
    var c = {h:0, s:0, l:(max + min) / 2};

    if (max == min)
        return c; // achromatic
    var d = max - min;
    c.s = c.l > 0.5 ? d / (2 - max - min) : d / (max + min);
    switch (max) {
        case col.r: c.h = (col.g - col.b) / d + (col.g < col.b ? 6 : 0); break;
        case col.g: c.h = (col.b - col.r) / d + 2; break;
        case col.b: c.h = (col.r - col.g) / d + 4; break;
    }
    c.h /= 6;
    // hue is an angle
    while (c.h > 1) c.h--;
    while (c.h < 0) c.h++;

    return c;
}

function hsl2rgb(col) {
    var c = {r:col.l, g:col.l, b:col.l};
    if (col.s == 0)
        return c; // achromatic
    var m2 = col.l > 0.5 ? col.l + col.s - col.l * col.s
           :               col.l * (col.s + 1);
    var m1 = col.l * 2 - m2;
    var n = -1;
    for(var k in c) {
        var h = col.h + n / 3;
        while (h > 1) h--;
        while (h < 0) h++;

        c[k] = 6 * h < 1 ? m1 + (m2 - m1) * h * 6
             : 2 * h < 1 ? m2
             : 3 * h < 2 ? m1 + (m2 - m1) * (2/3 - h) * 6
             :             m1;
        n++;
    }
    return c;
}

function CIEtransform(c) { // light matrix
    var _proc = 1 / 0.17697;
    return {
        x: _proc * (c.r * 0.489921 + c.g * 0.310016 + c.b * 0.200063),
        y: _proc * (c.r * 0.176937 + c.g * 0.812422 + c.b * 0.010641),
        z: _proc * (c.r * 0.000000 + c.g * 0.009999 + c.b * 0.990301)
    };
}

function interpolate(c1, c2, p) {
    var c = {};
    for (var k in c1)
        c[k] = c1[k]*(1-p) + c2[k]*p;
    return c;
}

var rs2pi = 1 / Math.sqrt(2 * Math.PI);
var sec = 0;
new Animation({frame:'60ms'}).on('tick', function (dt) {

    var t = sec/60/60; // sec as hours

    // nice_color = surface × lighting × simple_color
    var c = xyz2rgb(
        mul(
            CIEtransform( // human gamut (nicer colors)
                hsl2rgb({
                    // yellow → orange → red → violet → blue → green over 6h
                    h:(t % 6) / 6 + 2/3,
                    s:1.0,
                    l:0.5
                })
            )
        // night-day transition (in this case its the lumitance of the stimulus)
        ,0.1 *
        rs2pi*(Math.exp((-1)*Math.pow((t-12),2)/Math.pow(7/*day light*/,2)))
        )
    ); // surface missing!
//     var c = xyz2rgb(rgb2xyz(interpolate(c1, c2, p))); // workz!
//     var c = hsl2rgb(rgb2hsl(interpolate(c1, c2, p))); // workz!

    var body = document.getElementById('body');
    var txt = document.getElementById('txt');

    var rgb = "rgb("
            + Math.round(c.r * 255) + ", "
            + Math.round(c.g * 255) + ", "
            + Math.round(c.b * 255) + ")";
//     console.log(t, rgb, tr)
//     console.log(new Array(Math.floor(Math.abs(c.r)*80)).join(" "),"r")
//     console.log(new Array(Math.floor(Math.abs(c.g)*80)).join(" "),"g")
//     console.log(new Array(Math.floor(Math.abs(c.b)*80)).join(" "),"b")
    body.style.backgroundColor = rgb;

    var d = new Date(sec*1000);
    txt.textContent = pad(d.getHours(),   "0", 2) + ":"
                    + pad(d.getMinutes(), "0", 2) + ":"
                    + pad(d.getSeconds(), "0", 2);

    var c = dt / this.frametime; // tick correction
    sec += 200 * c;
    if (t >= 24) sec -= 24*60*60; // overflow → repeat the loop
}).start();
</script>
</html>
